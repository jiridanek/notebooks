# inspired by
# https://github.com/thesuperzapper/kubeflow/blob/master/.github/workflows/example_notebook_servers_publish_TEMPLATE.yaml
name: Build & Publish Notebook Servers (TEMPLATE)
on:
  workflow_call:
    inputs:
      target:
        required: true
        description: "make target to test"
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Free up additional disk space
        # https://docs.github.com/en/actions/learn-github-actions/expressions
        if: "${{ contains(inputs.target, 'cuda') || contains(inputs.target, 'pytorch') || contains(inputs.target, 'tensorflow') }}"
        run: |
          df -h

          sudo rm -rf /usr/include &
          sudo rm -rf /usr/local/lib/android &
          sudo rm -rf /usr/local/share/boost &
          sudo rm -rf /usr/local/lib/node_modules &
          sudo rm -rf /usr/share/dotnet &
          sudo rm -rf /opt/ghc &
          sudo rm -rf /opt/hostedtoolcache/CodeQL &
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"

          sudo docker image prune --all --force &

          wait

          df -h

      # https://docs.k0sproject.io/stable/k0s-in-docker/
      - run: docker run -d --name k0s --hostname k0s --privileged -v /var/lib/k0s -p 6443:6443 --cgroupns=host docker.io/k0sproject/k0s:v1.30.0-k0s.0 -- k0s controller --enable-worker

      - run: |
          mkdir -p $HOME/.kube
          docker cp k0s:/var/lib/k0s/pki/admin.conf $HOME/.kube/config
          until kubectl wait --for=condition=Ready nodes --all; do
            sleep 7
          done

      - run: "make deploy8-${{ inputs.target }}"
        if: "${{ contains(inputs.target, 'python-3.8') }}"

      - run: "make deploy9-${{ inputs.target }}"
        if: "${{ contains(inputs.target, 'python-3.9') }}"

      - run: "make test-${{ inputs.target }}"
        env:
          IMAGE_REGISTRY: "ghcr.io/${{ github.repository }}/workbench-images"

      - run: df -h
        if: "${{ !cancelled() }}"
